name: ðŸ§ª cd~

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run"
        type: boolean
        default: true

jobs:
  preflightchecks:
    runs-on: ubuntu-latest
    outputs:
      MOMMY_VERSION: ${{ steps.mommy_version.outputs.MOMMY_VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: fwdekker/mommy
      - name: Extract mommy's version number
        id: mommy_version
        run: |
          MOMMY_VERSION="v$(head -n 1 ./version)"
          echo "MOMMY_VERSION=$MOMMY_VERSION" >> "$GITHUB_ENV"
          echo "MOMMY_VERSION=$MOMMY_VERSION" >> "$GITHUB_OUTPUT"
      - name: Check if release already exists
        if: ${{ github.event.inputs.dry_run == 'false' }}
        # Using `fetch-tags` option of `actions/checkout` does not work properly!
        run: |
          git fetch --prune --unshallow --tags
          ! git show-ref --tags "$MOMMY_VERSION" --quiet

  intermediate:
    needs: [ preflightchecks ]
    runs-on: ubuntu-latest

    env:
      MOMMY_VERSION: ${{ needs.preflightchecks.outputs.MOMMY_VERSION }}

    steps:
      - name: Output version
        run: echo "$MOMMY_VERSION"

  run-a-thing:
    needs: [ intermediate ]
    runs-on: ubuntu-latest

    env:
      MOMMY_VERSION: ${{ needs.preflightchecks.outputs.MOMMY_VERSION }}

    steps:
      - name: Check in yml
        if: ${{ github.event.inputs.dry_run == 'false' }}
        run: |
          echo "::group::NOT A DRY RUN"
          echo "::endgroup::"
      - name: Check inside run
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "false" ]; then
            echo "::group::NOT A DRY RUN"
            echo "::endgroup::"
          else
            echo "::group::A DRY RUN"
            echo "::endgroup::"
          fi;
      - name: Output version
        run: echo "$MOMMY_VERSION"
